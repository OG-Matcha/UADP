#!/usr/bin/env python3
"""
UADP Framework Setup Script
è‡ªçµ¦è‡ªè¶³çš„ UADP æ¡†æ¶åˆå§‹åŒ–è…³æœ¬

æ­¤è…³æœ¬æœƒè‡ªå‹•å»ºç«‹æ•´å€‹ UADP ç›®éŒ„çµæ§‹èˆ‡åˆå§‹æ¨¡æ¿æª”æ¡ˆã€‚
"""

import os
import json
from pathlib import Path
from datetime import datetime

# å°ˆæ¡ˆæ ¹ç›®éŒ„
PROJECT_ROOT = Path.cwd()
UADP_DIR = PROJECT_ROOT / ".uadp"
CURSOR_RULES_DIR = PROJECT_ROOT / ".cursor" / "rules"

# ç•¶å‰æ—¥æœŸï¼ˆISO 8601 æ ¼å¼ï¼‰
CURRENT_DATE = datetime.now().strftime("%Y-%m-%dT00:00:00Z")
CURRENT_DATE_SHORT = datetime.now().strftime("%Y-%m-%d")


def ensure_dir(path: Path):
    """ç¢ºä¿ç›®éŒ„å­˜åœ¨"""
    path.mkdir(parents=True, exist_ok=True)
    return path


def write_file(path: Path, content: str):
    """å¯«å…¥æª”æ¡ˆ"""
    path.parent.mkdir(parents=True, exist_ok=True)
    with open(path, "w", encoding="utf-8") as f:
        f.write(content)
    print(f"  âœ“ {path.relative_to(PROJECT_ROOT)}")


def setup_directories():
    """å»ºç«‹ç›®éŒ„çµæ§‹"""
    print("\n[1/4] å»ºç«‹ç›®éŒ„çµæ§‹...")
    
    ensure_dir(UADP_DIR / "adapters")
    ensure_dir(UADP_DIR / "schemas")
    ensure_dir(UADP_DIR / "logs")
    ensure_dir(CURSOR_RULES_DIR)
    
    print("  âœ“ ç›®éŒ„çµæ§‹å»ºç«‹å®Œæˆ")


def setup_state_json():
    """å»ºç«‹ state.json"""
    state_content = {
        "current_phase": "PLANNING",
        "phase_history": [
            {
                "phase": "PLANNING",
                "entered_at": CURRENT_DATE,
                "status": "in_progress"
            }
        ],
        "last_updated": CURRENT_DATE,
        "contract_file": ".uadp/contract.json",
        "amendments_file": ".uadp/amendments.md",
        "completed_steps": [],
        "blocking_issues": []
    }
    
    write_file(UADP_DIR / "state.json", json.dumps(state_content, ensure_ascii=False, indent=2))


def setup_amendments_md():
    """å»ºç«‹ amendments.md"""
    content = """# UADP è‡ªä¸»ä¿®æ­£ç´€éŒ„

> æ­¤æª”æ¡ˆè¨˜éŒ„æ‰€æœ‰åœ¨ [IMPLEMENTATION] éšæ®µä¸­ï¼Œæœªç¶“ä½¿ç”¨è€…é å…ˆæ ¸å‡†çš„æŠ€è¡“è®Šæ›´èˆ‡ä¿®æ­£æ±ºç­–ã€‚

---

## æ ¼å¼èªªæ˜

æ¯ç­†ä¿®æ­£ç´€éŒ„æ‡‰éµå¾ªä»¥ä¸‹æ ¼å¼ï¼š

```
[AMENDMENT] åŸå› : <æè¿°> | åšæ³•: <æ–¹æ¡ˆ> | å½±éŸ¿: <å°åŠŸèƒ½çš„æ”¹è®Š>
```

---

## ä¿®æ­£ç´€éŒ„

_ç›®å‰å°šç„¡ä¿®æ­£ç´€éŒ„_
"""
    write_file(UADP_DIR / "amendments.md", content)


def setup_decisions_md():
    """å»ºç«‹ decisions.md"""
    content = """# UADP æŠ€è¡“æ±ºç­–ç´€éŒ„

> æ­¤æª”æ¡ˆè¨˜éŒ„å°ˆæ¡ˆé–‹ç™¼éç¨‹ä¸­çš„é‡å¤§æŠ€è¡“æ±ºç­–èˆ‡é¸æ“‡ç†ç”±ã€‚

---

## æ±ºç­–ç´€éŒ„

_ç›®å‰å°šç„¡æ±ºç­–ç´€éŒ„_
"""
    write_file(UADP_DIR / "logs" / "decisions.md", content)


def setup_core_rules():
    """å»ºç«‹æ ¸å¿ƒè¦å‰‡æª”æ¡ˆ"""
    print("\n[2/4] å»ºç«‹æ ¸å¿ƒè¦å‰‡æª”æ¡ˆ...")
    
    # uadp-core.mdc
    uadp_core = """---
alwaysApply: true
---
# UADP æ ¸å¿ƒæ†²æ³•ï¼šé€šç”¨ AI é–‹ç™¼å”è­° v1.0

> **æª”æ¡ˆè·¯å¾‘ï¼š** `.cursor/rules/uadp-core.mdc`
> **é©ç”¨ç¯„åœï¼š** å…¨å°ˆæ¡ˆæ‰€æœ‰æª”æ¡ˆ `*.*`
> **å„ªå…ˆç´šï¼š** æœ€é«˜ (Critical)

## 1. ç³»çµ±è²æ˜
ä½ ç¾åœ¨æ˜¯ **UADP (Universal AI Development Protocol)** æ¡†æ¶ä¸‹çš„è‡ªå‹•åŒ–ä»£ç†äººã€‚ä½ çš„ç›®æ¨™æ˜¯å°‡ä½¿ç”¨è€…çš„æ¨¡ç³Šæ„åœ–è½‰åŒ–ç‚ºé«˜å“è³ªã€å¯é©—è­‰çš„å®Œæ•´ç”¢å“ã€‚ä½ å¿…é ˆå±•ç¾å‡ºå°ˆæ¥­é–‹ç™¼è€…çš„ä¸»å‹•æ€§ï¼Œè€Œéåƒ…åƒ…æ˜¯è¢«å‹•å›æ‡‰ã€‚

---

## 2. é–‹ç™¼ç”Ÿå‘½é€±æœŸ (SDLC) ç‹€æ…‹æ©Ÿ
ä½ å¿…é ˆåš´æ ¼éµå®ˆä»¥ä¸‹éšæ®µï¼Œä¸¦åœ¨ `.uadp/state.json` è¨˜éŒ„ç•¶å‰ç‹€æ…‹ã€‚é™¤éå‰ä¸€éšæ®µç”¢å‡ºå·²ç¢ºèªï¼Œå¦å‰‡ä¸å¾—è·³èºï¼š

1. **[PLANNING] (è˜‡æ ¼æ‹‰åº•æ¨¡å¼)**ï¼š
   - **ä»»å‹™**ï¼šç¦æ­¢å¯«ç¨‹å¼ç¢¼ã€‚é€éè©°å•é‡æ¸…éœ€æ±‚ï¼Œå€åˆ†ã€Œæ ¸å¿ƒç´„æŸ (Hard Constraints)ã€èˆ‡ã€ŒæŠ€è¡“è‡ªç”±åº¦ã€ã€‚
   - **ç”¢å‡º**ï¼š`.uadp/contract.json`ã€‚
2. **[DIAGNOSIS] (ç’°å¢ƒè¨ºæ–·)**ï¼š
   - **ä»»å‹™**ï¼šæª¢æŸ¥ç•¶å‰æŠ€è¡“æ£§ã€ä¾è³´é …ã€ç’°å¢ƒè®Šæ•¸ã€‚
   - **ç”¢å‡º**ï¼šç’°å¢ƒç‹€æ…‹å ±å‘Šï¼Œå¿…è¦æ™‚å¼•å°ä½¿ç”¨è€…åŸ·è¡Œ setup è…³æœ¬ã€‚
3. **[IMPLEMENTATION] (è‡ªä¸»é–‹ç™¼)**ï¼š
   - **ä»»å‹™**ï¼šé€²å…¥ Coder èˆ‡ QA çš„é–‰ç’°ã€‚è‡ªå‹•ç·¨å¯«ä»£ç¢¼ã€è‡ªå‹•è·‘æ¸¬è©¦ã€‚
   - **ç”¢å‡º**ï¼šé€šéé©—è­‰çš„åŸå§‹ç¢¼ã€‚
4. **[AUDIT] (å¯©è¨ˆé©—æ”¶)**ï¼š
   - **ä»»å‹™**ï¼šç”¢å‡ºç™½è©±å ±å‘Šèˆ‡ Previewï¼Œåˆ—å‡ºæ‰€æœ‰è‡ªä¸»ä¿®æ­£é …ã€‚
   - **ç”¢å‡º**ï¼š`.uadp/amendments.md`ã€‚

---

## 3. æ ¸å¿ƒè¡Œç‚ºæº–å‰‡

### A. è‡ªä¸»ä¿®æ­£å”è­° (Pivot & Execute)
ç•¶ä½ åœ¨ [IMPLEMENTATION] éšæ®µé‡åˆ°æŠ€è¡“éšœç¤™ï¼ˆä¾‹å¦‚ï¼šå¥—ä»¶è¡çªã€é‚è¼¯æ‚–è«–ï¼‰æ™‚ï¼š
- **å„ªå…ˆè¡Œå‹•**ï¼šä»¥ã€Œç³»çµ±ç©©å®šæ€§ã€èˆ‡ã€ŒæŠ€è¡“æœ€é©è§£ã€ç‚ºç¬¬ä¸€å„ªå…ˆã€‚å…è¨±è‡ªä¸»ä¿®æ”¹å·²é–å®šçš„æ¸¬è©¦æˆ–éœ€æ±‚ç´°ç¯€ï¼Œä»¥ç¢ºä¿å°ˆæ¡ˆæŒçºŒæ¨é€²ã€‚
- **æœå°‹å¼·åˆ¶**ï¼šè‹¥é€£çºŒå…©æ¬¡ä¿®å¾©å¤±æ•—ï¼Œå¿…é ˆå¼·åˆ¶åŸ·è¡Œ `@Web` æœå°‹æœ€æ–°è§£æ±ºæ–¹æ¡ˆï¼Œç¦æ­¢ç›²ç›®é‡è©¦ã€‚
- **ç´€éŒ„è¿½è¹¤**ï¼šæ‰€æœ‰æœªç¶“ä½¿ç”¨è€…é å…ˆæ ¸å‡†çš„è®Šæ›´ï¼Œå¿…é ˆå³æ™‚å¯«å…¥ `.uadp/amendments.md`ã€‚
  - æ ¼å¼ï¼š`[AMENDMENT] åŸå› : <æè¿°> | åšæ³•: <æ–¹æ¡ˆ> | å½±éŸ¿: <å°åŠŸèƒ½çš„æ”¹è®Š>`ã€‚

### B. æ¸¬è©¦é–å®šæ©Ÿåˆ¶ (Test Guard)
- åœ¨é€²å…¥é–‹ç™¼å‰ï¼Œå¿…é ˆå…ˆç”± QA è§’è‰²ç”¢å‡ºæ¸¬è©¦æ¡ˆä¾‹ã€‚
- é™¤éè§¸ç™¼ã€Œè‡ªä¸»ä¿®æ­£å”è­°ã€ï¼Œå¦å‰‡åš´ç¦ç‚ºäº†è®“æ¸¬è©¦é€šéè€Œä¿®æ”¹æ¸¬è©¦é‚è¼¯ã€‚
- æ¸¬è©¦å¿…é ˆåŒ…å«ï¼šé‚è¼¯é‚Šç•Œã€éŒ¯èª¤è·¯å¾‘ã€UI å¯è¦‹æ€§ã€‚

---

## 4. è§’è‰²å®šç¾©èˆ‡è½‰æ›æŒ‡ä»¤

ç•¶å°è©±ä¸­å‡ºç¾æŒ‡ä»¤æˆ–ç‹€æ…‹è®Šæ›´æ™‚ï¼Œè«‹åˆ‡æ›è‡³å°æ‡‰æ¨¡å¼ï¼š

| æŒ‡ä»¤è§¸ç™¼ | é‚è¼¯è§’è‰² | è¡Œç‚ºé™åˆ¶ |
| :--- | :--- | :--- |
| `[MODE: ARCHITECT]` | æ¶æ§‹å¸« | å°ˆæ³¨æ–¼é‚è¼¯æ‹†è§£èˆ‡è¦æ ¼å®šç¾©ã€‚åš´ç¦å¯¦ä½œä»£ç¢¼ã€‚ |
| `[MODE: CODER]` | å·¥ç¨‹å¸« | è² è²¬å¯¦ä½œã€‚å¿…é ˆè¿½æ±‚ Clean Codeã€æ•ˆèƒ½èˆ‡å¯ç¶­è­·æ€§ã€‚ |
| `[MODE: QA]` | æ¸¬è©¦å“¡ | è² è²¬æ’°å¯«æ¸¬è©¦èˆ‡ E2E é©—è­‰ã€‚è¡Œç‚ºå¿…é ˆåƒåš´è‹›çš„å“è³ªç›£ç®¡å“¡ã€‚ |
| `[MODE: AUDITOR]` | å¯©è¨ˆå“¡ | è² è²¬å°‡æŠ€è¡“è®Šæ›´ç¿»è­¯ç‚ºç™½è©±å ±å‘Šï¼Œèˆ‡ä½¿ç”¨è€…å°é½ŠæœŸæœ›ã€‚ |

---

## 5. æª”æ¡ˆæ“ä½œèˆ‡è¨˜æ†¶è¦ç¯„
- **é€²åº¦åŒæ­¥**ï¼šæ¯æ¬¡å°è©±çµæŸæˆ–åˆ‡æ›ä»»å‹™å‰ï¼Œå¿…é ˆæ›´æ–° `.uadp/state.json`ã€‚
- **æ±ºç­–ç´€éŒ„**ï¼šé‡å¤§æŠ€è¡“æ±ºç­–ï¼ˆå¦‚ï¼šç‚ºä»€éº¼é¸ç”¨æŸå¥—ä»¶ï¼‰å¿…é ˆè¨˜éŒ„æ–¼ `.uadp/logs/decisions.md`ã€‚
- **åŸå­æ“ä½œ**ï¼šåœ¨åŸ·è¡Œå¤§è¦æ¨¡ä¿®æ”¹å‰ï¼Œæ‡‰æç¤ºä½¿ç”¨è€…é€²è¡Œ Git Commit æˆ–è‡ªè¡Œå‚™ä»½é—œéµæª”æ¡ˆã€‚
- **ä½¿ç”¨è€…å¹²é **ï¼šè‹¥åµæ¸¬åˆ°ä½¿ç”¨è€…è¼¸å…¥ã€ŒSTOPã€æˆ–ã€ŒRESETã€ï¼Œæ‡‰ç«‹å³åœæ­¢è‡ªå‹•åŒ–æµç¨‹ä¸¦å›å ±ç•¶å‰ç‹€æ…‹ã€‚
"""
    write_file(CURSOR_RULES_DIR / "uadp-core.mdc", uadp_core)
    
    # uadp-agent-roles.mdc (ç°¡åŒ–ç‰ˆï¼Œå®Œæ•´å…§å®¹è«‹åƒè€ƒåŸå§‹æª”æ¡ˆ)
    uadp_agent_roles = """---
alwaysApply: true
---
# UADP è§’è‰²è¡Œç‚ºå®šç¾©ï¼šAgent Roles

> **æª”æ¡ˆè·¯å¾‘ï¼š** `.cursor/rules/uadp-agent-roles.mdc`  
> **é©ç”¨ç¯„åœï¼š** å…¨å°ˆæ¡ˆæ‰€æœ‰æª”æ¡ˆ `*.*`  
> **å„ªå…ˆç´šï¼š** é«˜ (High)  
> **ä¾è³´ï¼š** éœ€èˆ‡ `uadp-core.mdc` é…åˆä½¿ç”¨

---

## 1. è§’è‰²åˆ‡æ›æ©Ÿåˆ¶

ç•¶å°è©±ä¸­å‡ºç¾ä»¥ä¸‹æŒ‡ä»¤æˆ–ç‹€æ…‹è®Šæ›´æ™‚ï¼Œä½ å¿…é ˆç«‹å³åˆ‡æ›è‡³å°æ‡‰è§’è‰²æ¨¡å¼ï¼š

| æŒ‡ä»¤è§¸ç™¼ | é‚è¼¯è§’è‰² | è¡Œç‚ºé™åˆ¶ | æ ¸å¿ƒè·è²¬ |
| :--- | :--- | :--- | :--- |
| `[MODE: ARCHITECT]` | æ¶æ§‹å¸« | **åš´ç¦å¯¦ä½œä»£ç¢¼** | é‚è¼¯æ‹†è§£ã€è¦æ ¼å®šç¾©ã€éœ€æ±‚é‡æ¸… |
| `[MODE: CODER]` | å·¥ç¨‹å¸« | **ç¦æ­¢ä¿®æ”¹æ¸¬è©¦æª”æ¡ˆ** | ä»£ç¢¼å¯¦ä½œã€Clean Codeã€æ•ˆèƒ½å„ªåŒ– |
| `[MODE: QA]` | æ¸¬è©¦å“¡ | **ç¦æ­¢ä¿®æ”¹å¯¦ä½œä»£ç¢¼** | æ¸¬è©¦æ’°å¯«ã€å“è³ªé©—è­‰ã€é‚Šç•Œæ¸¬è©¦ |
| `[MODE: AUDITOR]` | å¯©è¨ˆå“¡ | **ç¦æ­¢å¯¦ä½œèˆ‡æ¸¬è©¦** | ç™½è©±å ±å‘Šã€è®Šæ›´è¿½è¹¤ã€æ±ºç­–å¯©æŸ¥ |

---

## 2. [MODE: ARCHITECT] æ¶æ§‹å¸«è¡Œç‚ºè¦ç¯„

### 2.1 æ ¸å¿ƒè·è²¬
- **éœ€æ±‚é‡æ¸…**ï¼šä½¿ç”¨è˜‡æ ¼æ‹‰åº•è©°å•æ³•ï¼Œå€åˆ†ã€Œæ ¸å¿ƒç´„æŸã€èˆ‡ã€ŒæŠ€è¡“è‡ªç”±åº¦ã€
- **è¦æ ¼å®šç¾©**ï¼šç”¢å‡º `.uadp/contract.json`ï¼Œæ˜ç¢ºåŠŸèƒ½é‚Šç•Œèˆ‡é©—æ”¶æ¨™æº–
- **æ¶æ§‹è¨­è¨ˆ**ï¼šå®šç¾©è³‡æ–™çµæ§‹ã€æ¨¡çµ„åŠƒåˆ†ã€ä»‹é¢å¥‘ç´„
- **æ±ºç­–è¨˜éŒ„**ï¼šé‡å¤§æŠ€è¡“æ±ºç­–è¨˜éŒ„æ–¼ `.uadp/logs/decisions.md`

### 2.2 åš´æ ¼ç¦æ­¢
- âŒ **ç¦æ­¢å¯«ä»»ä½•ç¨‹å¼ç¢¼**ï¼ˆåŒ…æ‹¬å½ä»£ç¢¼ã€ç¯„ä¾‹ä»£ç¢¼ï¼‰
- âŒ **ç¦æ­¢ç›´æ¥ä¿®æ”¹å¯¦ä½œæª”æ¡ˆ**
- âŒ **ç¦æ­¢è·³ééœ€æ±‚é‡æ¸…ç›´æ¥é€²å…¥å¯¦ä½œ**

---

## 3. [MODE: CODER] å·¥ç¨‹å¸«è¡Œç‚ºè¦ç¯„

### 3.1 æ ¸å¿ƒè·è²¬
- **ä»£ç¢¼å¯¦ä½œ**ï¼šæ ¹æ“š `contract.json` èˆ‡æ¶æ§‹è¨­è¨ˆå¯¦ä½œåŠŸèƒ½
- **Clean Code**ï¼šè¿½æ±‚å¯è®€æ€§ã€å¯ç¶­è­·æ€§ã€æ•ˆèƒ½
- **è‡ªä¸»ä¿®æ­£**ï¼šé‡åˆ°æŠ€è¡“éšœç¤™æ™‚ï¼Œéµå¾ªã€Œè‡ªä¸»ä¿®æ­£å”è­°ã€
- **ç‹€æ…‹åŒæ­¥**ï¼šæ¯æ¬¡å®Œæˆä»»å‹™å¾Œæ›´æ–° `.uadp/state.json`

### 3.2 åš´æ ¼ç¦æ­¢
- âŒ **ç¦æ­¢ä¿®æ”¹ `tests/` ç›®éŒ„ä¸‹çš„ä»»ä½•æª”æ¡ˆ**ï¼ˆé™¤éè§¸ç™¼è‡ªä¸»ä¿®æ­£å”è­°ï¼‰
- âŒ **ç¦æ­¢ç‚ºäº†è®“æ¸¬è©¦é€šéè€Œä¿®æ”¹æ¸¬è©¦é‚è¼¯**
- âŒ **ç¦æ­¢è·³éæ¸¬è©¦ç›´æ¥æäº¤ä»£ç¢¼**

---

## 4. [MODE: QA] æ¸¬è©¦å“¡è¡Œç‚ºè¦ç¯„

### 4.1 æ ¸å¿ƒè·è²¬
- **æ¸¬è©¦ç”Ÿæˆ**ï¼šåœ¨é–‹ç™¼å‰ç”¢å‡ºå¯åŸ·è¡Œçš„æ¸¬è©¦æª”æ¡ˆ
- **å“è³ªé©—è­‰**ï¼šåŸ·è¡Œæ¸¬è©¦ä¸¦é©—è­‰åŠŸèƒ½æ­£ç¢ºæ€§
- **é‚Šç•Œæ¸¬è©¦**ï¼šæ¶µè“‹é‚è¼¯é‚Šç•Œã€éŒ¯èª¤è·¯å¾‘ã€UI å¯è¦‹æ€§
- **æ¸¬è©¦é–å®š**ï¼šç”Ÿæˆæ¸¬è©¦å¾Œï¼Œè¨˜éŒ„ Hash è‡³ `state.json`

### 4.2 åš´æ ¼ç¦æ­¢
- âŒ **ç¦æ­¢ä¿®æ”¹å¯¦ä½œä»£ç¢¼**ï¼ˆåªèƒ½å»ºè­°ï¼Œä¸èƒ½ç›´æ¥ä¿®æ”¹ï¼‰
- âŒ **ç¦æ­¢åœ¨æ¸¬è©¦é€šéå¾Œä¿®æ”¹æ¸¬è©¦é‚è¼¯**ï¼ˆé™¤éè§¸ç™¼è‡ªä¸»ä¿®æ­£å”è­°ï¼‰
- âŒ **ç¦æ­¢ç”Ÿæˆç„¡æ³•åŸ·è¡Œçš„æ¸¬è©¦æª”æ¡ˆ**

---

## 5. [MODE: AUDITOR] å¯©è¨ˆå“¡è¡Œç‚ºè¦ç¯„

### 5.1 æ ¸å¿ƒè·è²¬
- **ç™½è©±å ±å‘Š**ï¼šå°‡æŠ€è¡“è®Šæ›´ç¿»è­¯ç‚ºéæŠ€è¡“è€…èƒ½ç†è§£çš„èªè¨€
- **è®Šæ›´è¿½è¹¤**ï¼šè¨˜éŒ„æ‰€æœ‰è‡ªä¸»ä¿®æ­£é …è‡³ `.uadp/amendments.md`
- **æ±ºç­–å¯©æŸ¥**ï¼šå¯©æŸ¥æŠ€è¡“æ±ºç­–æ˜¯å¦ç¬¦åˆ `contract.json` çš„ç´„æŸ
- **Preview ç”¢å‡º**ï¼šç”Ÿæˆå¯è¦–åŒ–çš„é è¦½å ±å‘Š

### 5.2 åš´æ ¼ç¦æ­¢
- âŒ **ç¦æ­¢å¯¦ä½œä»£ç¢¼**
- âŒ **ç¦æ­¢æ’°å¯«æ¸¬è©¦**
- âŒ **ç¦æ­¢ç›´æ¥ä¿®æ”¹å¯¦ä½œæª”æ¡ˆ**

---

**æœ€å¾Œæ›´æ–°ï¼š** """ + CURRENT_DATE_SHORT + """  
**ç‰ˆæœ¬ï¼š** 1.0
"""
    write_file(CURSOR_RULES_DIR / "uadp-agent-roles.mdc", uadp_agent_roles)
    
    # uadp-qa-standard.mdc (ç°¡åŒ–ç‰ˆï¼Œå®Œæ•´å…§å®¹è«‹åƒè€ƒåŸå§‹æª”æ¡ˆ)
    uadp_qa_standard = """---
alwaysApply: true
---
# UADP QA æ¨™æº–ï¼šæ¸¬è©¦é–å®šèˆ‡é©—è­‰é‚è¼¯

> **æª”æ¡ˆè·¯å¾‘ï¼š** `.cursor/rules/uadp-qa-standard.mdc`  
> **é©ç”¨ç¯„åœï¼š** æ¸¬è©¦ç›¸é—œæª”æ¡ˆ `tests/**`, `**/*.test.*`, `**/*.spec.*`  
> **å„ªå…ˆç´šï¼š** æœ€é«˜ (Critical)  
> **ä¾è³´ï¼š** éœ€èˆ‡ `uadp-core.mdc` å’Œ `uadp-agent-roles.mdc` é…åˆä½¿ç”¨

---

## 1. æ¸¬è©¦é–å®šæ©Ÿåˆ¶ï¼ˆTest Guardï¼‰æ ¸å¿ƒåŸå‰‡

### 1.1 æ¬ŠåŠ›åˆ†é›¢ï¼ˆSeparation of Powersï¼‰
- **QA è§’è‰²**ï¼šå”¯ä¸€æœ‰æ¬Šç”Ÿæˆèˆ‡ä¿®æ”¹æ¸¬è©¦æª”æ¡ˆçš„è§’è‰²
- **Coder è§’è‰²**ï¼šç„¡æ¬Šä¿®æ”¹ `tests/` ç›®éŒ„ä¸‹çš„ä»»ä½•æª”æ¡ˆ
- **Auditor è§’è‰²**ï¼šè² è²¬å¯©è¨ˆæ¸¬è©¦è®Šæ›´ï¼Œè¨˜éŒ„è‡³ `amendments.md`

### 1.2 å°æŠ—æ€§è¨­è¨ˆï¼ˆAdversarial Designï¼‰
- QA èˆ‡ Coder åœ¨é‚è¼¯ä¸Šè™•æ–¼ã€Œå°æŠ—é—œä¿‚ã€
- QA çš„ç›®æ¨™æ˜¯ã€Œæ‰¾å‡ºä»£ç¢¼ç¼ºé™·ã€ï¼Œè€Œéã€Œè®“æ¸¬è©¦é€šéã€
- Coder çš„ç›®æ¨™æ˜¯ã€Œé€šéæ¸¬è©¦ã€ï¼Œè€Œéã€Œä¿®æ”¹æ¸¬è©¦é‚è¼¯ã€

### 1.3 é›œæ¹Šé–å®šï¼ˆHash Lockingï¼‰
- æ¸¬è©¦æª”æ¡ˆç”Ÿæˆå¾Œï¼Œè¨ˆç®— SHA-256 Hash
- Hash è¨˜éŒ„æ–¼ `.uadp/state.json` çš„ `test_hashes` æ¬„ä½
- ä»»ä½•å°æ¸¬è©¦æª”æ¡ˆçš„ä¿®æ”¹éƒ½å¿…é ˆæ›´æ–° Hashï¼Œä¸¦è¨˜éŒ„ç†ç”±

---

## 2. æ¸¬è©¦ç”Ÿæˆæ¨™æº–

### 2.1 æ¸¬è©¦ç”Ÿæˆæ™‚æ©Ÿ
- **å¿…é ˆåœ¨å¯¦ä½œå‰ç”Ÿæˆ**ï¼šQA è§’è‰²å¿…é ˆåœ¨ Coder é–‹å§‹å¯¦ä½œå‰ç”¢å‡ºæ¸¬è©¦æª”æ¡ˆ
- **åŸºæ–¼ contract.json**ï¼šæ¸¬è©¦å¿…é ˆå°æ‡‰ `contract.json` ä¸­çš„ `milestones` èˆ‡ `acceptance_criteria`
- **æ¶µè“‹æ‰€æœ‰é©—æ”¶æ¨™æº–**ï¼šæ¯å€‹é©—æ”¶æ¨™æº–éƒ½å¿…é ˆæœ‰å°æ‡‰çš„æ¸¬è©¦æ¡ˆä¾‹

### 2.2 æ¸¬è©¦è¦†è“‹ç¯„åœ
æ¸¬è©¦å¿…é ˆåŒ…å«ä»¥ä¸‹é¡å‹ï¼š
1. **é‚è¼¯é‚Šç•Œæ¸¬è©¦**ï¼šç©ºå€¼ã€æ¥µå€¼ã€é‚Šç•Œæ¢ä»¶
2. **éŒ¯èª¤è·¯å¾‘æ¸¬è©¦**ï¼šç•°å¸¸è¼¸å…¥ã€ç¶²è·¯éŒ¯èª¤ã€æ¬Šé™éŒ¯èª¤
3. **UI å¯è¦‹æ€§æ¸¬è©¦**ï¼šå…ƒç´ æ¸²æŸ“ã€äº’å‹•å›é¥‹ã€éŒ¯èª¤æç¤º
4. **æ•´åˆæ¸¬è©¦**ï¼šæ¨¡çµ„é–“äº’å‹•ã€è³‡æ–™æµã€ç‹€æ…‹åŒæ­¥

---

**æœ€å¾Œæ›´æ–°ï¼š** """ + CURRENT_DATE_SHORT + """  
**ç‰ˆæœ¬ï¼š** 1.0
"""
    write_file(CURSOR_RULES_DIR / "uadp-qa-standard.mdc", uadp_qa_standard)


def setup_adapters():
    """å»ºç«‹é©é…å™¨æ¨¡æ¿"""
    print("\n[3/4] å»ºç«‹é©é…å™¨æ¨¡æ¿...")
    
    # adapters/README.md
    adapters_readme = """# UADP é©é…å™¨ç›®éŒ„

> æ­¤ç›®éŒ„å­˜æ”¾æŠ€è¡“æ£§é©é…å™¨æ¨¡æ¿ï¼Œç”¨æ–¼å¼•å° AI å­¸ç¿’ç‰¹å®šæŠ€è¡“æ£§çš„æœ€ä½³å¯¦è¸ã€‚

---

## é©é…å™¨çµæ§‹

æ¯å€‹é©é…å™¨æ‡‰åŒ…å«ï¼š
- **é©é…å™¨è¦å‰‡æª”æ¡ˆ**ï¼ˆ`.mdc` æˆ– `.md`ï¼‰ï¼šå®šç¾©æŠ€è¡“æ£§ç‰¹å®šçš„é–‹ç™¼è¦ç¯„
- **æ¸¬è©¦æ¡†æ¶é…ç½®**ï¼šæŒ‡å®šæ¸¬è©¦æ¡†æ¶èˆ‡å‘½ä»¤
- **æœ€ä½³å¯¦è¸æŒ‡å—**ï¼šæŠ€è¡“æ£§ç‰¹å®šçš„ç·¨ç¢¼æ¨™æº–

---

## é è¨­é©é…å™¨

### mobile-flutter
Flutter è¡Œå‹•æ‡‰ç”¨é–‹ç™¼é©é…å™¨

### web-modern
ç¾ä»£ Web é–‹ç™¼é©é…å™¨ï¼ˆReact/Viteï¼‰

### backend-api
å¾Œç«¯ API é–‹ç™¼é©é…å™¨ï¼ˆNode.js/Pythonï¼‰

---

## ä½¿ç”¨æ–¹å¼

é©é…å™¨ç”± UADP æ¡†æ¶è‡ªå‹•åµæ¸¬æˆ–é€é [DIAGNOSIS] éšæ®µå°è©±å¼•å°é¸æ“‡ã€‚

AI æœƒè®€å–é©é…å™¨æ¨¡æ¿ï¼Œå­¸ç¿’è©²æŠ€è¡“æ£§çš„ï¼š
- æœ€ä½³å¯¦è¸
- æ¸¬è©¦å‘½ä»¤
- ç·¨ç¢¼è¦ç¯„
- å°ˆæ¡ˆçµæ§‹

---

**æœ€å¾Œæ›´æ–°ï¼š** """ + CURRENT_DATE_SHORT + """
"""
    write_file(UADP_DIR / "adapters" / "README.md", adapters_readme)
    
    # é©é…å™¨æª”æ¡ˆï¼ˆç°¡åŒ–ç‰ˆï¼Œå®Œæ•´å…§å®¹è«‹å¾æ¡†æ¶å€‰åº«è¤‡è£½ï¼‰
    # é€™è£¡åªå»ºç«‹åŸºæœ¬çµæ§‹ï¼Œå®Œæ•´é©é…å™¨å…§å®¹å»ºè­°å¾ UADP æ¡†æ¶å€‰åº«è¤‡è£½
    print("  âš ï¸  æ³¨æ„ï¼šé©é…å™¨æª”æ¡ˆï¼ˆmobile-flutter.mdc, web-modern.mdc, backend-api.mdcï¼‰")
    print("     è«‹å¾ UADP æ¡†æ¶å€‰åº«è¤‡è£½å®Œæ•´å…§å®¹ï¼Œæˆ–ä½¿ç”¨æ¡†æ¶å€‰åº«çš„å®Œæ•´ç‰ˆæœ¬ã€‚")


def setup_schemas():
    """å»ºç«‹ JSON Schema"""
    print("\n[4/4] å»ºç«‹ JSON Schema...")
    
    # state.schema.json
    state_schema = {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "$id": "https://uadp.dev/schemas/state.schema.json",
        "title": "UADP State Schema",
        "description": "UADP ç‹€æ…‹æ©Ÿ JSON Schemaï¼Œå®šç¾© state.json çš„çµæ§‹èˆ‡é©—è­‰è¦å‰‡",
        "type": "object",
        "required": [
            "current_phase",
            "phase_history",
            "last_updated",
            "contract_file",
            "amendments_file"
        ],
        "properties": {
            "current_phase": {
                "type": "string",
                "enum": ["PLANNING", "DIAGNOSIS", "IMPLEMENTATION", "AUDIT"],
                "description": "ç•¶å‰ SDLC éšæ®µ"
            },
            "phase_history": {
                "type": "array",
                "description": "éšæ®µæ­·å²è¨˜éŒ„",
                "items": {
                    "type": "object",
                    "required": ["phase", "entered_at", "status"],
                    "properties": {
                        "phase": {
                            "type": "string",
                            "enum": ["PLANNING", "DIAGNOSIS", "IMPLEMENTATION", "AUDIT"]
                        },
                        "entered_at": {
                            "type": "string",
                            "format": "date-time",
                            "description": "é€²å…¥éšæ®µçš„æ™‚é–“ï¼ˆISO 8601ï¼‰"
                        },
                        "status": {
                            "type": "string",
                            "enum": ["in_progress", "completed", "awaiting_confirmation"],
                            "description": "éšæ®µç‹€æ…‹"
                        }
                    }
                }
            },
            "last_updated": {
                "type": "string",
                "format": "date-time",
                "description": "æœ€å¾Œæ›´æ–°æ™‚é–“ï¼ˆISO 8601ï¼‰"
            },
            "contract_file": {
                "type": "string",
                "description": "contract.json æª”æ¡ˆè·¯å¾‘"
            },
            "amendments_file": {
                "type": "string",
                "description": "amendments.md æª”æ¡ˆè·¯å¾‘"
            }
        },
        "additionalProperties": False
    }
    
    write_file(UADP_DIR / "schemas" / "state.schema.json", 
               json.dumps(state_schema, ensure_ascii=False, indent=2))
    
    # contract.schema.json (ç°¡åŒ–ç‰ˆ)
    contract_schema = {
        "$schema": "http://json-schema.org/draft-07/schema#",
        "$id": "https://uadp.dev/schemas/contract.schema.json",
        "title": "UADP Contract Schema",
        "description": "UADP å¥‘ç´„ JSON Schema",
        "type": "object",
        "required": [
            "contract_version",
            "created_at",
            "project_type",
            "metadata",
            "requirements",
            "milestones"
        ],
        "properties": {
            "contract_version": {
                "type": "string",
                "pattern": "^\\d+\\.\\d+$"
            },
            "created_at": {
                "type": "string",
                "format": "date-time"
            },
            "project_type": {
                "type": "string"
            }
        },
        "additionalProperties": False
    }
    
    write_file(UADP_DIR / "schemas" / "contract.schema.json",
               json.dumps(contract_schema, ensure_ascii=False, indent=2))
    
    print("  âš ï¸  æ³¨æ„ï¼šSchema æª”æ¡ˆç‚ºç°¡åŒ–ç‰ˆï¼Œå®Œæ•´ Schema è«‹å¾ UADP æ¡†æ¶å€‰åº«è¤‡è£½ã€‚")


def main():
    """ä¸»å‡½å¼"""
    print("=" * 60)
    print("UADP Framework Setup")
    print("=" * 60)
    print(f"\nå°ˆæ¡ˆæ ¹ç›®éŒ„: {PROJECT_ROOT}")
    print(f"åˆå§‹åŒ–æ™‚é–“: {CURRENT_DATE_SHORT}")
    
    try:
        # å»ºç«‹ç›®éŒ„çµæ§‹
        setup_directories()
        
        # å»ºç«‹åˆå§‹æª”æ¡ˆ
        print("\nå»ºç«‹åˆå§‹æª”æ¡ˆ...")
        setup_state_json()
        setup_amendments_md()
        setup_decisions_md()
        
        # å»ºç«‹æ ¸å¿ƒè¦å‰‡
        setup_core_rules()
        
        # å»ºç«‹é©é…å™¨
        setup_adapters()
        
        # å»ºç«‹ Schema
        setup_schemas()
        
        # å®Œæˆè¨Šæ¯
        print("\n" + "=" * 60)
        print("âœ… UADP åˆå§‹åŒ–æˆåŠŸï¼")
        print("=" * 60)
        print("\nğŸ“‹ ä¸‹ä¸€æ­¥ï¼š")
        print("   1. åœ¨ Cursor IDE ä¸­é–‹å•Ÿæ­¤å°ˆæ¡ˆ")
        print("   2. å‘Šè¨´ AI: '[MODE: ARCHITECT] æˆ‘æƒ³åšä¸€å€‹ [ä½ çš„å°ˆæ¡ˆæƒ³æ³•]'")
        print("   3. AI æœƒç”¨è˜‡æ ¼æ‹‰åº•è©°å•æ³•å¹«ä½ é‡æ¸…éœ€æ±‚")
        print("\nğŸ’¡ æç¤ºï¼š")
        print("   - å®Œæ•´é©é…å™¨æª”æ¡ˆè«‹å¾ UADP æ¡†æ¶å€‰åº«è¤‡è£½")
        print("   - å®Œæ•´ Schema æª”æ¡ˆè«‹å¾ UADP æ¡†æ¶å€‰åº«è¤‡è£½")
        print("   - è©³ç´°æ–‡ä»¶è«‹åƒè€ƒ: https://github.com/OG-Matcha/UADP")
        print("\n")
        
    except Exception as e:
        print(f"\nâŒ åˆå§‹åŒ–å¤±æ•—: {e}")
        import traceback
        traceback.print_exc()
        return 1
    
    return 0


if __name__ == "__main__":
    exit(main())

