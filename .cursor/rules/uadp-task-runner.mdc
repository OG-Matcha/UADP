---
alwaysApply: true
---
# UADP 任務驅動協議：Task Runner Protocol

> **檔案路徑：** `.cursor/rules/uadp-task-runner.mdc`  
> **適用範圍：** 全專案所有檔案 `*.*`  
> **優先級：** 最高 (Critical)  
> **依賴：** 需與 `uadp-core.mdc` 和 `uadp-agent-roles.mdc` 配合使用  
> **最後更新：** 2026-01-09  
> **版本：** 1.0

---

## 1. 核心原則：任務驅動執行

### 1.1 任務看板（Task Board）

AI 必須在根目錄維護一個 `.uadp/tasks.md` 檔案，作為任務看板。

**檔案格式：**
```markdown
# UADP 任務看板

## 當前階段：[PLANNING|DIAGNOSIS|IMPLEMENTATION|AUDIT]

## 任務清單

### Task 1: [任務名稱]
- **狀態**：pending | in_progress | completed | blocked
- **角色**：ARCHITECT | CODER | QA | AUDITOR
- **描述**：[任務詳細描述]
- **驗收標準**：[如何判定完成]
- **依賴**：[前置任務，如：Task 1]

### Task 2: [任務名稱]
...
```

### 1.2 強制讀取規則

**每次進入 [IMPLEMENTATION] 階段時，AI 必須：**

1. ✅ **讀取 `tasks.md`**：在開始任何實作前，必須先讀取任務看板
2. ✅ **按順序執行**：嚴格按照任務清單的順序執行，不得跳躍
3. ✅ **更新狀態**：每完成一個任務，立即更新 `tasks.md` 中的狀態為 `completed`

---

## 2. 鏈式執行協議（Chained Execution Protocol）

### 2.1 原子任務完成後的強制行為

**當一個 `[MODE]` 的原子任務完成且測試通過後：**

- ❌ **禁止產出長篇結論**：不得撰寫冗長的完成報告、總結或說明
- ✅ **必須直接打印**：`✅ Task [N] 完成，自動切換至下一個任務...`
- ✅ **立即執行**：無需等待使用者確認，直接開始執行下一個任務
- ✅ **更新狀態**：在 `tasks.md` 中將該任務標記為 `completed`

**範例：**
```
✅ Task 1 完成，自動切換至下一個任務...

[MODE: QA] 開始為 Task 2 生成測試...
```

### 2.2 錯誤處理與中斷條件

**只有在以下情況，才准許停下來請求使用者協助：**

1. **無法自主解決的錯誤**：
   - 連續兩次修復失敗
   - 遇到需要使用者決策的技術選擇（如：選擇資料庫類型）
   - 環境配置問題（如：缺少必要的系統權限）

2. **阻塞狀態（Blocked）**：
   - 前置任務未完成
   - 外部依賴未就緒（如：API 金鑰未提供）
   - 需要使用者提供額外資訊

**錯誤報告格式：**
```
❌ Task [N] 執行失敗：[錯誤描述]

[錯誤詳情]

需要使用者協助：
- [具體問題]
- [建議解決方案]
```

---

## 3. 任務狀態機

### 3.1 狀態轉換規則

| 當前狀態 | 允許轉換至 | 觸發條件 |
| :--- | :--- | :--- |
| `pending` | `in_progress` | AI 開始執行該任務 |
| `in_progress` | `completed` | 任務完成且通過驗證 |
| `in_progress` | `blocked` | 遇到無法自主解決的問題 |
| `blocked` | `in_progress` | 使用者提供協助後 |
| `completed` | - | 終態，不可再轉換 |

### 3.2 狀態更新時機

- **開始執行**：立即將狀態更新為 `in_progress`
- **完成驗證**：測試通過後，立即更新為 `completed`
- **遇到阻塞**：立即更新為 `blocked`，並記錄阻塞原因

---

## 4. 角色銜接規則（Role Chaining）

### 4.1 [MODE: ARCHITECT] 完成後的強制行為

**當 ARCHITECT 完成規劃並產出 `contract.json` 後：**

1. ✅ **必須初始化 `tasks.md`**：
   - 根據 `contract.json` 中的 `milestones` 生成任務清單
   - 將所有任務標記為 `pending`
   - 設定當前階段為 `IMPLEMENTATION`

2. ✅ **必須下令執行**：
   - 打印：`✅ 規劃完成，任務清單已初始化。執行任務清單...`
   - 自動切換至第一個任務的對應角色（通常是 `[MODE: QA]` 或 `[MODE: CODER]`）

**範例：**
```markdown
✅ 規劃完成，任務清單已初始化。執行任務清單...

[MODE: QA] 開始為 Task 1 生成測試...
```

### 4.2 [MODE: CODER] 完成後的強制行為

**當 CODER 完成實作且測試通過後：**

1. ✅ **必須自動觸發 QA**：
   - 打印：`✅ Task [N] 實作完成，自動觸發測試驗證...`
   - 立即切換至 `[MODE: QA]` 執行測試驗證

2. ✅ **禁止產出長篇報告**：
   - 不得撰寫實作說明、代碼解釋或技術細節
   - 僅打印簡短的完成訊息

**範例：**
```
✅ Task 1 實作完成，自動觸發測試驗證...

[MODE: QA] 執行測試驗證...
```

### 4.3 [MODE: QA] 完成後的強制行為

**當 QA 通過驗證後：**

1. ✅ **檢查剩餘任務**：
   - 讀取 `tasks.md`，檢查是否還有 `pending` 狀態的任務

2. ✅ **自動銜接**：
   - **若還有剩餘任務**：打印 `✅ Task [N] 測試通過，自動切換至下一個任務...`，立即切換至 `[MODE: CODER]` 執行下一個任務
   - **若所有任務完成**：打印 `✅ 所有任務完成，進入審計階段...`，切換至 `[MODE: AUDITOR]`

**範例：**
```
✅ Task 1 測試通過，自動切換至下一個任務...

[MODE: CODER] 開始實作 Task 2...
```

---

## 5. 長程複合指令（Long-Range Composite Commands）

### 5.1 外部 AI 指令格式

**外部 AI（ChatGPT/Gemini）可以產出長程複合指令，要求 Cursor 執行多個任務：**

**格式：**
```markdown
[TO CURSOR]

請讀取 `.uadp/tasks.md` 並執行從 Task [N] 到 Task [M] 的所有內容。
中途無需回報，除非報錯。
```

**範例：**
```markdown
[TO CURSOR]

請讀取 `.uadp/tasks.md` 並執行從 Task 1 到 Task 5 的所有內容。
中途無需回報，除非報錯。
```

### 5.2 執行規則

**當收到長程複合指令時：**

1. ✅ **讀取任務看板**：讀取 `.uadp/tasks.md`
2. ✅ **按順序執行**：從指定起始任務開始，依序執行至結束任務
3. ✅ **最小回報**：僅在以下情況回報：
   - 任務完成（簡短訊息：`✅ Task [N] 完成`）
   - 遇到錯誤（詳細錯誤報告）
   - 所有任務完成（最終總結）

4. ❌ **禁止行為**：
   - 禁止在每個任務完成後產出長篇報告
   - 禁止請求使用者確認（除非遇到阻塞）

---

## 6. 任務看板初始化範例

### 6.1 ARCHITECT 初始化範例

**當 ARCHITECT 完成規劃後，應產出如下格式的 `tasks.md`：**

```markdown
# UADP 任務看板

## 當前階段：IMPLEMENTATION

## 任務清單

### Task 1: 生成待辦事項模型測試
- **狀態**：pending
- **角色**：QA
- **描述**：為 Todo 模型生成單元測試，包含邊界測試和錯誤路徑測試
- **驗收標準**：測試檔案生成且通過語法檢查
- **依賴**：無

### Task 2: 實作 Todo 模型
- **狀態**：pending
- **角色**：CODER
- **描述**：根據 contract.json 實作 Todo 資料模型
- **驗收標準**：通過 Task 1 生成的測試
- **依賴**：Task 1

### Task 3: 生成待辦事項服務測試
- **狀態**：pending
- **角色**：QA
- **描述**：為 TodoService 生成整合測試
- **驗收標準**：測試檔案生成且通過語法檢查
- **依賴**：Task 2

### Task 4: 實作 TodoService
- **狀態**：pending
- **角色**：CODER
- **描述**：實作待辦事項的 CRUD 操作服務
- **驗收標準**：通過 Task 3 生成的測試
- **依賴**：Task 3

### Task 5: 生成 UI 元件測試
- **狀態**：pending
- **角色**：QA
- **描述**：為 TodoList 元件生成 UI 可見性測試
- **驗收標準**：測試檔案生成且通過語法檢查
- **依賴**：Task 4

### Task 6: 實作 TodoList UI 元件
- **狀態**：pending
- **角色**：CODER
- **描述**：實作待辦事項列表 UI 元件
- **驗收標準**：通過 Task 5 生成的測試
- **依賴**：Task 5
```

---

## 7. 違規處理

### 7.1 違規行為定義

以下行為視為違規：

1. ❌ **跳過任務看板**：在 [IMPLEMENTATION] 階段未讀取 `tasks.md` 就開始實作
2. ❌ **產出長篇結論**：在原子任務完成後撰寫冗長的完成報告
3. ❌ **請求不必要確認**：在任務完成後請求使用者確認（除非遇到阻塞）
4. ❌ **跳躍執行**：不按順序執行任務，或跳過前置任務

### 7.2 違規處理流程

```
1. 偵測到違規行為
   ↓
2. 立即停止當前操作
   ↓
3. 記錄違規至 amendments.md
   ↓
4. 重新讀取 tasks.md 並從正確位置繼續
```

---

## 8. 最佳實踐

### 8.1 任務拆分原則

- **原子性**：每個任務應該是獨立的、可驗證的單元
- **可測試性**：每個任務都應該有明確的驗收標準
- **依賴清晰**：明確標註任務之間的依賴關係

### 8.2 狀態更新原則

- **即時更新**：狀態變更時立即更新 `tasks.md`
- **一致性**：確保 `tasks.md` 與實際執行狀態一致
- **可追溯性**：保留任務執行歷史（可選：記錄完成時間）

---

**最後更新：** 2026-01-09  
**版本：** 1.0